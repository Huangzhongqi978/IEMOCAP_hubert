# IEMOCAP语音情感识别系统 - 可视化功能说明

## 🎯 功能概述

本次更新为IEMOCAP情感识别训练代码添加了完整的可视化功能，包括：

1. **训练曲线图** - 监控训练过程
2. **注意力权重热力图** - 分析模型关注点
3. **情感概率时序图** - 展示预测置信度
4. **混淆矩阵** - 分析分类性能
5. **综合分析报告** - 全面的性能总结

## 📊 可视化功能详解

### 1. 训练曲线图 (`plot_training_curves`)

**功能**: 显示训练过程中各项指标的变化趋势

**包含图表**:
- 训练/测试损失曲线
- 准确率曲线 (整体准确率 + UA)
- F1分数曲线 (宏平均 + 加权平均)
- 精确率/召回率曲线
- 各情感类别F1分数趋势
- 最佳性能标记点

**生成位置**: `plots/training_curves_fold_*.png`

### 2. 注意力权重热力图 (`plot_attention_heatmap`)

**功能**: 可视化模型的注意力机制

**实现逻辑**:
- ✅ **真实注意力**: 如果模型启用了attention机制，提取真实的注意力权重
- ⚠️ **模拟注意力**: 如果模型没有attention，创建对角线模式的模拟权重用于演示

**适配说明**:
```python
# 检查模型是否有真实的注意力机制
has_attention = hasattr(model, 'attention') and model.attention

if has_attention:
    # 手动执行前向传播获取注意力权重
    alpha_weights = []
    for t in emotions:
        att_em, alpha_ = model.matchatt(emotions, t, mask=None)
        alpha_weights.append(alpha_[:, 0, :])
```

**生成位置**: `plots/attention_heatmap_fold_*.png`

### 3. 情感概率时序图 (`plot_emotion_probability_timeline`)

**功能**: 展示每个样本的情感预测概率分布

**显示内容**:
- 4个情感类别的预测概率条形图
- 真实标签高亮显示（绿色边框）
- 预测标签透明度增强
- 正确/错误预测标记 (✓/✗)

**情感标签映射**:
```python
emotion_labels = {0: 'Angry', 1: 'Happy', 2: 'Neutral', 3: 'Sad'}
emotion_colors = ['#e74c3c', '#f1c40f', '#95a5a6', '#3498db']
```

**生成位置**: `plots/emotion_probabilities_fold_*.png`

### 4. 综合分析报告 (`create_comprehensive_analysis_report`)

**功能**: 生成跨所有fold的综合性能分析

**包含内容**:
- 总体性能指标分布
- 各fold性能对比
- 情感类别数据分布
- 综合混淆矩阵
- 各类别详细性能
- 性能指标箱线图
- 各情感类别性能趋势

**生成位置**: `comprehensive_analysis_report.png`

## 🔧 中文编码解决方案

### 字体设置
```python
import matplotlib
matplotlib.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'DejaVu Sans', 'Arial Unicode MS']
matplotlib.rcParams['axes.unicode_minus'] = False
```

### 本地化设置
```python
import locale
try:
    locale.setlocale(locale.LC_ALL, 'zh_CN.UTF-8')
except:
    try:
        locale.setlocale(locale.LC_ALL, 'Chinese_China.UTF-8')
    except:
        print("⚠️ 无法设置中文本地化，可能影响中文显示")
```

## ⚠️ 重要注意事项

### 1. 注意力权重获取

**问题**: 原始的GRU模型只在前向传播内部使用注意力，不直接返回注意力权重。

**解决方案**: 
- 手动执行模型的前向传播步骤
- 在注意力计算过程中收集权重
- 如果获取失败，创建合理的模拟权重

### 2. 数据加载器适配

**修复**: 更新了数据加载器的解包方式
```python
# 原来 (错误)
for batch_idx, (data, target) in enumerate(test_loader):

# 修复后 (正确)
for batch_idx, (data, target, lengths, data_id) in enumerate(test_loader):
```

### 3. CUDA设备处理

**确保一致性**:
```python
data = data.cuda()
target = target.cuda()
```

### 4. 情感标签一致性

**验证**: 确保所有可视化函数使用相同的情感标签映射
```python
emotion_labels = {0: 'Angry', 1: 'Happy', 2: 'Neutral', 3: 'Sad'}
```

## 🧪 测试验证

### 快速验证脚本

运行 `test_visualization_simple.py` 来验证：
- ✅ 中文字符显示正常
- ✅ 情感标签正确映射
- ✅ 颜色方案一致
- ✅ 图表布局合理

### 完整功能测试

运行训练代码时，可视化功能会自动生成以下文件：
```
experiments/emotion_recognition_YYYYMMDD_HHMMSS/
├── plots/
│   ├── training_curves_fold_*.png      # 训练曲线
│   ├── attention_heatmap_fold_*.png    # 注意力热力图
│   ├── emotion_probabilities_fold_*.png # 情感概率图
│   ├── best_confusion_matrix_fold_*.png # 混淆矩阵
│   └── comprehensive_analysis_report.png # 综合分析
└── ...
```

## 🎨 可视化效果预览

### 训练曲线特点
- 📈 多子图布局，信息丰富
- 🎯 最佳性能点标记
- 📊 各类别性能对比
- 🔍 详细的数值标注

### 注意力热力图特点
- 🔥 YlOrRd颜色方案，直观易读
- ✅ 真实/模拟注意力区分显示
- 📝 预测结果对比标注
- 🎨 专业的科学可视化风格

### 情感概率图特点
- 🎨 情感专用配色方案
- ✓ 预测正确性标记
- 📊 概率数值精确显示
- 🎯 真实标签高亮

## 💡 使用建议

1. **首次运行**: 建议先运行测试脚本验证环境
2. **注意力分析**: 重点关注注意力是否为真实权重
3. **性能监控**: 利用训练曲线及时发现过拟合
4. **错误分析**: 通过混淆矩阵和概率图分析错误模式
5. **跨fold比较**: 使用综合分析报告评估模型稳定性

## 🔍 故障排除

### 常见问题

1. **中文乱码**: 
   - 安装中文字体包
   - 检查系统locale设置

2. **注意力权重获取失败**:
   - 会自动回退到模拟权重
   - 检查模型attention参数设置

3. **CUDA内存不足**:
   - 减少max_samples参数
   - 使用CPU模式测试

4. **图片生成失败**:
   - 检查目录权限
   - 确认matplotlib版本兼容性

---

**更新时间**: 2025年9月26日  
**版本**: v1.0  
**兼容性**: Python 3.7+, PyTorch 1.8+, matplotlib 3.3+


